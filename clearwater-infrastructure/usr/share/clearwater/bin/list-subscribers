#!/usr/bin/env python
# Copyright (C) 2016 Metaswitch Networks Ltd. All rights reserved.

import sys
import requests
import argparse
from configobj import ConfigObj


parser = argparse.ArgumentParser(description='Lists the subscribers currently '
                                             'assigned to this S-CSCF.')
args = parser.parse_args()


CONFIG_FILE = '/etc/clearwater/shared_config'
API_KEY = 'hs_mgmt_hostname'


def main():
    # Find the location to query for all the IMPUs.
    config = ConfigObj(CONFIG_FILE)
    api_address = config.get(API_KEY)
    if not api_address:
        sys.exit('Unable to find value of {}. Is it set in {}?'
                 .format(API_KEY, CONFIG_FILE))

    # Build the URL for this request.
    url = 'http://{}/impu'.format(api_address)

    try:
        r = requests.get(url)
    except requests.exceptions.ConnectionError:
        sys.exit('Unable to connect to the HTTP stack. Please contact your '
                 'system administrator.')

    if r.status_code == 200:
        try:
            impus = r.json()['impus']
        except ValueError:
            sys.exit('Subscribers returned in unexpected format. Please '
                     'contact your system administrator.')
    elif r.status_code == 500:
        sys.exit('Unable to query cache for subscriber information. Please '
                 'contact your system administrator.')
    else:
        sys.exit('Operation failed with unexpected {} error. Please contact '
                 'your system administrator.'.format(r.status_code))

    # The IMPUs can come back in any order. Allegedly it makes more sense to
    # display them ordered.
    impus.sort()

    print 'Subscribers with cached data:'
    print
    print '\n'.join(impus)

    sys.exit(0)


if __name__ == '__main__':
    main()
